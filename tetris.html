<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Ç—Ä–∏—Å</title>
    <style>
        body {
            text-align: center;
            background-color: #282c34;
            color: white;
            font-family: Arial, sans-serif;
        }
        canvas {
            background-color: black;
            display: block;
            margin: auto;
        }
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .controls button {
            font-size: 20px;
            margin: 5px;
            padding: 10px;
            cursor: pointer;
        }
        .music-controls {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>–¢–µ—Ç—Ä–∏—Å</h1>
    <h2>–°—á–µ—Ç: <span id="score">0</span></h2>
    <canvas id="tetris" width="300" height="600"></canvas>
    <div class="controls">
        <button id="left">‚¨ÖÔ∏è</button>
        <button id="rotate">üîÑ</button>
        <button id="down">‚¨áÔ∏è</button>
        <button id="right">‚û°Ô∏è</button>
    </div>

    <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –º—É–∑—ã–∫–∏ -->
    <div class="music-controls">
        <button id="music-toggle-on">–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É</button>
        <button id="music-toggle-off">–í—ã–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É</button>
    </div>

    <!-- –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–Ω–æ–≤—É—é –º—É–∑—ã–∫—É -->
    <audio id="background-music" loop autoplay>
        <source id="music-source" src="song1.mp3" type="audio/mpeg">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç audio.
    </audio>

    <script>
        const canvas = document.getElementById("tetris");
        const context = canvas.getContext("2d");

        const ROWS = 20;
        const COLUMNS = 10;
        const COLORS = [null, "red", "blue", "green", "yellow", "purple", "orange", "cyan", "pink", "lime"];
        const BLOCK_SIZE = 30; // –†–∞–∑–º–µ—Ä –∫–∞–∂–¥–æ–π –∫–ª–µ—Ç–∫–∏
        let score = 0;
        let dropCounter = 0;
        let lastTime = 0;
        const dropInterval = 500;

        // –ú–∞—Å—Å–∏–≤ –ø–µ—Å–µ–Ω –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
        const songs = [
            "song1.mp3", // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É —Ñ–∞–π–ª—É
            "song2.mp3", // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É —Ñ–∞–π–ª—É
            "song3.mp3"  // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É —Ñ–∞–π–ª—É
        ];

        const audioElement = document.getElementById("background-music");
        const musicSource = document.getElementById("music-source");

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –ø–µ—Å–Ω–∏ —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
        function changeSong() {
            const randomSong = songs[Math.floor(Math.random() * songs.length)];
            musicSource.src = randomSong;
            audioElement.load();
            audioElement.play();
        }

        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø–µ—Å–Ω–∏ –∏ –º–µ–Ω—è–µ–º –µ—ë
        audioElement.addEventListener('ended', changeSong);

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º—É–∑—ã–∫–æ–π
        document.getElementById("music-toggle-on").addEventListener("click", function() {
            audioElement.play();
            this.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–∫–ª—é—á–µ–Ω–∏—è
            document.getElementById("music-toggle-off").style.display = "inline"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–∫–ª—é—á–µ–Ω–∏—è
        });

        document.getElementById("music-toggle-off").addEventListener("click", function() {
            audioElement.pause();
            this.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–∫–ª—é—á–µ–Ω–∏—è
            document.getElementById("music-toggle-on").style.display = "inline"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–∫–ª—é—á–µ–Ω–∏—è
        });

        function updateScore(points) {
            score += points;
            document.getElementById("score").innerText = score;
        }

        function createMatrix(w, h) {
            return Array.from({ length: h }, () => Array(w).fill(0));
        }

        function drawMatrix(matrix, offset) {
            matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value) {
                        context.fillStyle = COLORS[value]; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –∏–∑ –º–∞—Å—Å–∏–≤–∞ COLORS
                        context.fillRect((x + offset.x) * BLOCK_SIZE, (y + offset.y) * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                        context.strokeStyle = "black";
                        context.strokeRect((x + offset.x) * BLOCK_SIZE, (y + offset.y) * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                    }
                });
            });
        }

        function createPiece() {
            const pieces = [
                { shape: [[1, 1, 1], [0, 1, 0]], color: 1 },  // –ö—Ä–∞—Å–Ω—ã–π
                { shape: [[2, 2], [2, 2]], color: 2 },        // –°–∏–Ω–∏–π
                { shape: [[0, 3, 3], [3, 3, 0]], color: 3 },  // –ó–µ–ª–µ–Ω—ã–π
                { shape: [[4, 4, 0], [0, 4, 4]], color: 4 },  // –ñ–µ–ª—Ç—ã–π
                { shape: [[5, 5, 5, 5]], color: 5 },          // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
                { shape: [[0, 6, 0], [0, 6, 0], [6, 6, 0]], color: 6 }, // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                { shape: [[0, 7, 0], [0, 7, 0], [0, 7, 7]], color: 7 } // –¶–∏–∞–Ω
            ];
            const randomPiece = pieces[Math.floor(Math.random() * pieces.length)];
            return randomPiece;
        }

        function isValidMove(matrix, pos) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ —Ñ–∏–≥—É—Ä–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
            for (let y = 0; y < matrix.length; y++) {
                for (let x = 0; x < matrix[y].length; x++) {
                    if (matrix[y][x]) {
                        const newX = pos.x + x;
                        const newY = pos.y + y;
                        if (newX < 0 || newX >= COLUMNS || newY >= ROWS || board[newY] && board[newY][newX]) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function moveDown() {
            player.pos.y++;
            if (!isValidMove(player.matrix, player.pos)) {
                player.pos.y--;
                merge();
            }
        }

        function moveLeft() {
            player.pos.x--;
            if (!isValidMove(player.matrix, player.pos)) {
                player.pos.x++;
            }
        }

        function moveRight() {
            player.pos.x++;
            if (!isValidMove(player.matrix, player.pos)) {
                player.pos.x--;
            }
        }

        function merge() {
            player.matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value) {
                        board[y + player.pos.y][x + player.pos.x] = value;
                    }
                });
            });

            // –£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω—ã–µ —Ä—è–¥—ã
            const removedLines = removeFullLines();
            updateScore(removedLines * 100); // –ö–∞–∂–¥–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ä—è–¥–∞ –¥–∞—ë—Ç 100 –æ—á–∫–æ–≤
            player.matrix = createPiece().shape;
            player.pos = { x: 4, y: 0 };
            if (!isValidMove(player.matrix, player.pos)) {
                // –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
                alert("Game Over!");
                resetGame();
            }
        }

        function removeFullLines() {
            let linesRemoved = 0;
            outer: for (let row = ROWS - 1; row >= 0; row--) {
                if (board[row].every(cell => cell !== 0)) { // –ï—Å–ª–∏ —Ä—è–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω
                    board.splice(row, 1); // –£–¥–∞–ª—è–µ–º —Ä—è–¥
                    board.unshift(Array(COLUMNS).fill(0)); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π —Ä—è–¥ —Å–≤–µ—Ä—Ö—É
                    linesRemoved++;
                    row++; // –°–¥–≤–∏–≥–∞–µ–º –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã —Å–Ω–æ–≤–∞ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —ç—Ç–æ—Ç —Ä—è–¥
                }
            }
            return linesRemoved;
        }

        function resetGame() {
            board.length = 0;
            player.pos = { x: 4, y: 0 };
            player.matrix = createPiece().shape;
        }

        function rotate(matrix) {
            const rotated = matrix[0].map((_, index) =>
                matrix.map(row => row[index])
            ).reverse();
            return rotated;
        }

        function rotatePiece() {
            const rotated = rotate(player.matrix);
            const backupPos = { ...player.pos };

            if (isValidMove(rotated, player.pos)) {
                player.matrix = rotated;
            } else {
                // –ü—Ä–æ–±—É–µ–º —Å–¥–≤–∏–≥–∞—Ç—å —Ñ–∏–≥—É—Ä—É –≤–ª–µ–≤–æ –Ω–∞ –æ–¥–Ω—É –∫–ª–µ—Ç–∫—É –∏ –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–≤–µ—Ä–Ω—É—Ç—å —Ñ–∏–≥—É—Ä—É
                player.pos.x--;
                if (isValidMove(rotated, player.pos)) {
                    player.matrix = rotated;
                } else {
                    player.pos = backupPos; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é, –µ—Å–ª–∏ –≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
                }
            }
        }

        const board = createMatrix(COLUMNS, ROWS);
        const player = { pos: { x: 4, y: 0 }, matrix: createPiece().shape, color: createPiece().color };

        function update(time = 0) {
            const deltaTime = time - lastTime;
            lastTime = time;
            dropCounter += deltaTime;
            if (dropCounter > dropInterval) {
                moveDown();
                dropCounter = 0;
            }
            draw();
            requestAnimationFrame(update);
        }

        function draw() {
            context.fillStyle = "black";
            context.fillRect(0, 0, canvas.width, canvas.height);
            drawMatrix(board, { x: 0, y: 0 });
            drawMatrix(player.matrix, player.pos);
        }

        document.getElementById("left").addEventListener("click", moveLeft);
        document.getElementById("right").addEventListener("click", moveRight);
        document.getElementById("down").addEventListener("click", moveDown);
        document.getElementById("rotate").addEventListener("click", rotatePiece);

        update();
    </script>
</body>
</html>
